#!/bin/sh

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}


if [[ -f $CACHE_DIR/bin/grafana-agent ]]; then
  echo "-----> Reusing cached agent"
  cp -f "$CACHE_DIR/bin/grafana-agent" "$BUILD_DIR/bin/grafana-agent"
else
  echo "-----> Download grafana agent binary..."
  mkdir -p $BUILD_DIR/bin
  curl -O -L --silent "https://github.com/grafana/agent/releases/download/v0.30.1/agent-linux-amd64.zip"
  unzip agent-linux-amd64.zip 
  mv agent-linux-amd64 $BUILD_DIR/bin/grafana-agent
  rm agent-linux-amd64.zip
  cp -f "$BUILD_DIR/bin/grafana-agent" "$CACHE_DIR//bin/grafana-agent"

  echo "-----> Grafana agent binary installed."
  
fi


echo "-----> Substituting envrionment variables."
envsubst < $BUILD_DIR/config/grafana-agent.yml > $BUILD_DIR//config/grafana-agent.yml

# Debugging
cat $BUILD_DIR/config/grafana-agent.yml